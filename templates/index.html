<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DPDSL Playground</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --border: #2a2d3a;
    --accent: #6c63ff;
    --accent-hover: #5a52e0;
    --text: #e2e4e9;
    --muted: #8b8fa3;
    --red: #ff6b6b;
    --green: #51cf66;
    --yellow: #fcc419;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }
  .container { max-width: 960px; margin: 0 auto; padding: 2rem 1.5rem; }

  /* Header */
  header { margin-bottom: 2rem; }
  header h1 { font-size: 1.75rem; margin-bottom: .25rem; }
  header h1 span { color: var(--accent); }
  header p { color: var(--muted); font-size: .95rem; line-height: 1.5; }

  /* Mode toggle */
  .mode-bar {
    display: flex; align-items: center; gap: .75rem;
    margin-bottom: 1.5rem;
  }
  .mode-bar label { color: var(--muted); font-size: .85rem; font-weight: 600; text-transform: uppercase; letter-spacing: .05em; }
  .toggle-group {
    display: inline-flex; border: 1px solid var(--border); border-radius: 6px; overflow: hidden;
  }
  .toggle-group button {
    background: transparent; border: none; color: var(--muted);
    padding: .45rem 1rem; font-size: .85rem; cursor: pointer; transition: all .15s;
  }
  .toggle-group button.active {
    background: var(--accent); color: #fff;
  }

  /* Query area */
  .query-section { margin-bottom: 1.5rem; }
  textarea {
    width: 100%; min-height: 100px; padding: .85rem 1rem;
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); font-family: 'Cascadia Code', 'Fira Code', monospace; font-size: .9rem;
    resize: vertical; outline: none; transition: border-color .15s;
  }
  textarea:focus { border-color: var(--accent); }
  .btn-row { display: flex; gap: .5rem; margin-top: .75rem; }
  .btn {
    padding: .55rem 1.25rem; border: none; border-radius: 6px;
    font-size: .85rem; font-weight: 600; cursor: pointer; transition: all .15s;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-primary:disabled { opacity: .5; cursor: not-allowed; }
  .btn-secondary { background: var(--surface); color: var(--muted); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--muted); color: var(--text); }

  /* Examples */
  .examples { margin-bottom: 1.5rem; }
  .examples h3 { font-size: .85rem; color: var(--muted); margin-bottom: .5rem; text-transform: uppercase; letter-spacing: .05em; }
  .example-list { display: flex; flex-wrap: wrap; gap: .4rem; }
  .example-btn {
    background: var(--surface); border: 1px solid var(--border); border-radius: 6px;
    color: var(--text); padding: .35rem .7rem; font-size: .78rem; cursor: pointer;
    font-family: 'Cascadia Code', 'Fira Code', monospace; transition: all .15s;
  }
  .example-btn:hover { border-color: var(--accent); color: var(--accent); }
  .example-btn.blocked { border-color: var(--red); color: var(--red); opacity: .7; }

  /* Budget bar */
  .budget-bar {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: .85rem 1rem; margin-bottom: 1.5rem;
  }
  .budget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: .4rem; }
  .budget-header span { font-size: .8rem; color: var(--muted); }
  .budget-header strong { font-size: .9rem; }
  .bar-track {
    width: 100%; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;
  }
  .bar-fill {
    height: 100%; border-radius: 3px; transition: width .3s, background .3s;
    background: var(--green);
  }
  .bar-fill.warn { background: var(--yellow); }
  .bar-fill.danger { background: var(--red); }

  /* Results */
  .results-section { margin-bottom: 1.5rem; }
  .results-section h3 { font-size: .85rem; color: var(--muted); margin-bottom: .5rem; text-transform: uppercase; letter-spacing: .05em; }
  .result-box {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 1rem; overflow-x: auto;
  }
  table { width: 100%; border-collapse: collapse; font-size: .85rem; }
  th { text-align: left; color: var(--muted); padding: .4rem .6rem; border-bottom: 1px solid var(--border); font-weight: 600; }
  td { padding: .4rem .6rem; border-bottom: 1px solid var(--border); }
  tr:last-child td { border-bottom: none; }
  .empty-state { color: var(--muted); text-align: center; padding: 2rem 0; font-size: .9rem; }
  .error-box {
    background: rgba(255,107,107,.08); border: 1px solid rgba(255,107,107,.25); border-radius: 8px;
    padding: .85rem 1rem; color: var(--red); font-size: .85rem; white-space: pre-wrap;
    font-family: 'Cascadia Code', 'Fira Code', monospace;
  }

  /* Verbose log */
  .verbose-section { margin-bottom: 1.5rem; }
  .verbose-section h3 { font-size: .85rem; color: var(--muted); margin-bottom: .5rem; text-transform: uppercase; letter-spacing: .05em; }
  .verbose-box {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: .85rem 1rem; font-family: 'Cascadia Code', 'Fira Code', monospace;
    font-size: .78rem; color: var(--muted); white-space: pre-wrap; max-height: 250px; overflow-y: auto;
  }

  /* Spinner */
  .spinner {
    display: inline-block; width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,.3); border-top-color: #fff;
    border-radius: 50%; animation: spin .6s linear infinite;
    margin-right: .4rem; vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1><span>DPDSL</span> Playground</h1>
    <p>
      Write SQL-like queries with differential privacy annotations.
      Mark columns as <code>PRIVATE</code> (protected with DP noise) or <code>PUBLIC</code> (safe to query).
      Each query costs privacy budget (epsilon). When your budget runs out, reset to keep exploring.
    </p>
  </header>

  <!-- Mode toggle -->
  <div class="mode-bar">
    <label>Mode</label>
    <div class="toggle-group">
      <button id="btn-prod" class="active" onclick="setMode('production')">Production</button>
      <button id="btn-dev" onclick="setMode('development')">Development</button>
    </div>
  </div>

  <!-- Example queries -->
  <div class="examples">
    <h3>Example Queries</h3>
    <div class="example-list">
      <button class="example-btn" onclick="useExample(this)">SELECT AVG(PRIVATE Salary OF [1.0]) FROM employee</button>
      <button class="example-btn" onclick="useExample(this)">SELECT COUNT(PRIVATE Salary OF [0.5]) FROM employee</button>
      <button class="example-btn" onclick="useExample(this)">SELECT SUM(PRIVATE Salary OF [1.0]) FROM employee</button>
      <button class="example-btn" onclick="useExample(this)">SELECT AVG(PRIVATE Salary OF [0.5]), PUBLIC State FROM employee GROUP BY PUBLIC State</button>
      <button class="example-btn" onclick="useExample(this)">SELECT AVG(PRIVATE budget OF [1.0]) FROM employee JOIN projects ON employee.id = projects.employee_id</button>
      <button class="example-btn blocked" onclick="useExample(this)">SELECT PRIVATE Email FROM employee</button>
    </div>
  </div>

  <!-- Query input -->
  <div class="query-section">
    <textarea id="query" placeholder="SELECT AVG(PRIVATE Salary OF [1.0]) FROM employee"></textarea>
    <div class="btn-row">
      <button class="btn btn-primary" id="run-btn" onclick="runQuery()">Run Query</button>
      <button class="btn btn-secondary" onclick="resetBudget()">Reset Budget</button>
    </div>
  </div>

  <!-- Budget bar -->
  <div class="budget-bar">
    <div class="budget-header">
      <span>Privacy Budget</span>
      <strong id="budget-label">10.00 / 10.00</strong>
    </div>
    <div class="bar-track">
      <div class="bar-fill" id="budget-fill" style="width:100%"></div>
    </div>
  </div>

  <!-- Error -->
  <div id="error-section" style="display:none; margin-bottom:1.5rem;">
    <div class="error-box" id="error-msg"></div>
  </div>

  <!-- Results -->
  <div class="results-section">
    <h3>Results</h3>
    <div class="result-box" id="result-box">
      <div class="empty-state">Run a query to see results</div>
    </div>
  </div>

  <!-- Verbose log (dev mode only) -->
  <div class="verbose-section" id="verbose-section" style="display:none;">
    <h3>Verbose Log</h3>
    <div class="verbose-box" id="verbose-box"></div>
  </div>
</div>

<script>
let currentMode = "production";

function setMode(mode) {
  currentMode = mode;
  document.getElementById("btn-prod").classList.toggle("active", mode === "production");
  document.getElementById("btn-dev").classList.toggle("active", mode === "development");
  document.getElementById("verbose-section").style.display = mode === "development" ? "" : "none";
  refreshBudget();
}

function useExample(btn) {
  document.getElementById("query").value = btn.textContent;
}

async function runQuery() {
  const query = document.getElementById("query").value.trim();
  if (!query) return;

  const btn = document.getElementById("run-btn");
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Running...';
  document.getElementById("error-section").style.display = "none";

  try {
    const res = await fetch("/query", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query, mode: currentMode }),
    });
    const data = await res.json();

    // Update budget
    if (data.budget) updateBudget(data.budget);

    // Show verbose log
    if (data.verbose_log && currentMode === "development") {
      document.getElementById("verbose-box").textContent = data.verbose_log;
      document.getElementById("verbose-section").style.display = "";
    }

    // Error
    if (data.error) {
      document.getElementById("error-section").style.display = "";
      document.getElementById("error-msg").textContent = data.error;
      document.getElementById("result-box").innerHTML = '<div class="empty-state">Query returned an error</div>';
      return;
    }

    // Results
    renderResults(data.results || []);
  } catch (e) {
    document.getElementById("error-section").style.display = "";
    document.getElementById("error-msg").textContent = "Network error: " + e.message;
  } finally {
    btn.disabled = false;
    btn.textContent = "Run Query";
  }
}

function renderResults(rows) {
  const box = document.getElementById("result-box");
  if (!rows.length) {
    box.innerHTML = '<div class="empty-state">No rows returned</div>';
    return;
  }
  const cols = rows[0].length;
  let html = "<table><thead><tr>";
  for (let i = 0; i < cols; i++) html += `<th>Column ${i + 1}</th>`;
  html += "</tr></thead><tbody>";
  for (const row of rows) {
    html += "<tr>";
    for (const val of row) {
      const display = val === null ? "NULL" : typeof val === "number" ? val.toLocaleString(undefined, { maximumFractionDigits: 2 }) : val;
      html += `<td>${escapeHtml(String(display))}</td>`;
    }
    html += "</tr>";
  }
  html += "</tbody></table>";
  box.innerHTML = html;
}

function escapeHtml(s) {
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function updateBudget(b) {
  const pct = (b.remaining / b.max) * 100;
  document.getElementById("budget-label").textContent =
    `${b.remaining.toFixed(2)} / ${b.max.toFixed(2)}  (${b.queries} queries)`;
  const fill = document.getElementById("budget-fill");
  fill.style.width = pct + "%";
  fill.className = "bar-fill" + (pct < 20 ? " danger" : pct < 50 ? " warn" : "");
}

async function refreshBudget() {
  try {
    const res = await fetch(`/budget?mode=${currentMode}`);
    const data = await res.json();
    updateBudget(data);
  } catch (e) { /* ignore */ }
}

async function resetBudget() {
  try {
    await fetch("/reset", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: currentMode }),
    });
    refreshBudget();
    document.getElementById("error-section").style.display = "none";
    document.getElementById("result-box").innerHTML = '<div class="empty-state">Budget reset. Run a query to see results</div>';
  } catch (e) { /* ignore */ }
}

// Initial budget load
refreshBudget();
</script>
</body>
</html>
